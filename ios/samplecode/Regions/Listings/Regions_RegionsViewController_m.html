<!DOCTYPE html>
<html lang="en">
<head>
    <title>Regions: Regions/RegionsViewController.m</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta charset="utf-8">
    <meta id="book-resource-type" name="book-resource-type" content="Sample Code">
    <meta scheme="apple_ref" id="identifier" name="identifier" content="//apple_ref/doc/uid/DTS40010726">
	<meta id="document-version" name="document-version" content="2.0.0">
    <meta id="build" name="build" content="bcf073e0579478458b78c3b3068a2133">
    <meta id="chapterId" name="chapterId" content="DTS40010726-Regions_RegionsViewController_m">
    <meta id="date" name="date" content="2011-03-23">
    <meta id="description" name="description" content="Demonstrates region monitoring, significant location changes, and handling location events in the background on iOS.">
    <meta id="book-title" name="book-title" content="Regions">
    <meta id="book-name" name="book-name" content="DTS_SC2130_Regions">
    <meta id="book-root" name="book-root" content="../">
    <meta id="book-json" name="book-json" content="../book.json">
    <meta id="devcenter" name="devcenter" content="iOS Dev Center">
    <meta id="devcenter-url" name="devcenter-url" content="http://developer.apple.com/devcenter/ios">
    <meta id="reflib" name="reflib" content="iOS Developer Library">
    <meta id="book-assignments" name="book-assignments" content="{Type/Sample Code}, {Framework/Cocoa Touch Layer/MapKit}, {Topic/User Experience}">
    
    
    <meta id="generator" name="generator" content="Gutenberg 003a3034">
    <meta name='numbat' content='aa879094b666337fdcde744b62fbff30'>
    <meta id="copyright" name="copyright" content="Copyright 2014 Apple Inc. All Rights Reserved.">
    <meta id="xcode-display" name="xcode-display" content="render">
    <meta id="IndexTitle" name="IndexTitle" content="Regions/RegionsViewController.m">
    <meta id="resources-uri" name="resources-uri" content="../../../Resources/874">
    <link id="book-index-page" rel="Start" title="Regions" type="text/html" href="../index.html">
    <link id="next-page" rel="Next" type="text/html" href="../History/History.html">
    <link id="previous-page" rel="Prev" type="text/html" href="Regions_RegionsViewController_h.html">
    <link rel="stylesheet" type="text/css" href="../../../Resources/874/CSS/screen.css">
    
    <link rel="stylesheet" type="text/css" href="../../../Resources/874/CSS/feedback.css">
</head>    
<body><a name="//apple_ref/doc/uid/DTS40010726-Regions_RegionsViewController_m" title="Regions/RegionsViewController.m"></a>
    <div id="adcHeader" class="hideOnPrint hideInXcode">
        <div id='ssi_Header' class="hideInXcode phone">
            <a id="ssi_LibraryTitle" href='../../../navigation/index.html'>iOS Developer Library</a>
            <a id="ssi_AppleDeveloperConnection" href='../../../../../index.html'>Developer</a>
            <div id='ssi_SearchButton' role="button" title="Search">Search</div>
        </div>
        <form id='ssi_SearchMenu' method='get' action='../../../search/' accept-charset='utf-8'>
            <label for='adcsearch'>Search iOS Developer Library</label>
            <input type='search' id='ssi_SearchField' name='q' accesskey='s' results='5' />
        </form>
    </div>

    <header id="header">
        <div id="title" role="banner">
            <h1>Regions</h1>
            <span id="file_links">
                <a id="PDF_link" role="button" tabindex='4' rel="alternate" title="Download PDF"><span id="pdf_icon"></span>PDF</a>
                <a id="Companion_link" role="button" tabindex='3' title="Download Companion File"><span id="companion_icon"></span>Companion File</a>
            </span>
        </div>
        <ul id="headerButtons" class="hideOnPrint" role="toolbar">
            <li id="toc_button" style="display:none">
                <button tabindex="5" id="table_of_contents" class="open" role="checkbox" aria-label="Show Table of Contents"><span class="disclosure"></span>Table of Contents</button>
            </li>
            <li id="jumpto_button" style="display:none" role="navigation"><select tabindex="6" id="jumpTo"><option value="top">Jump To&#133;</option></select></li>
            <li id="downloadSample_button" style="display:none">
                <a id="Sample_link"><button id="Sample_button">Download Sample Code</button></a>
            </li>
        </ul>
    </header>
    <nav id="tocContainer" tabindex="7">
        <ul id="toc" role="tree"></ul>
    </nav>

    <article id="contents" tabindex="0" role="main">
        <div id="pageNavigationLinks_top" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='../History/History.html'>Next</a><a class='previousLink' rel='prev' href='Regions_RegionsViewController_h.html'>Previous</a>
        </div>
        <a id="top" name="top"></a>
        <a id="INDEX" href="../index.html" style="display:none;"></a>
        
        <a name="//apple_ref/doc/uid/DTS40010726-Regions_RegionsViewController_m-DontLinkElementID_11" title="Regions/RegionsViewController.m"></a>
    <h1 id="pageTitle">Regions/RegionsViewController.m</h1>
    <div class="codesample clear"><table><tr><td scope="row"><pre>/*<span></span></pre></td></tr><tr><td scope="row"><pre>     File: RegionsViewController.m<span></span></pre></td></tr><tr><td scope="row"><pre> Abstract: This controller manages the CLLocationManager for location updates and switches the interface between showing the region map and the updates table list. This controller also manages adding and removing regions to be monitored by the application.<span></span></pre></td></tr><tr><td scope="row"><pre>  Version: 1.1<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple<span></span></pre></td></tr><tr><td scope="row"><pre> Inc. ("Apple") in consideration of your agreement to the following<span></span></pre></td></tr><tr><td scope="row"><pre> terms, and your use, installation, modification or redistribution of<span></span></pre></td></tr><tr><td scope="row"><pre> this Apple software constitutes acceptance of these terms.  If you do<span></span></pre></td></tr><tr><td scope="row"><pre> not agree with these terms, please do not use, install, modify or<span></span></pre></td></tr><tr><td scope="row"><pre> redistribute this Apple software.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> In consideration of your agreement to abide by the following terms, and<span></span></pre></td></tr><tr><td scope="row"><pre> subject to these terms, Apple grants you a personal, non-exclusive<span></span></pre></td></tr><tr><td scope="row"><pre> license, under Apple's copyrights in this original Apple software (the<span></span></pre></td></tr><tr><td scope="row"><pre> "Apple Software"), to use, reproduce, modify and redistribute the Apple<span></span></pre></td></tr><tr><td scope="row"><pre> Software, with or without modifications, in source and/or binary forms;<span></span></pre></td></tr><tr><td scope="row"><pre> provided that if you redistribute the Apple Software in its entirety and<span></span></pre></td></tr><tr><td scope="row"><pre> without modifications, you must retain this notice and the following<span></span></pre></td></tr><tr><td scope="row"><pre> text and disclaimers in all such redistributions of the Apple Software.<span></span></pre></td></tr><tr><td scope="row"><pre> Neither the name, trademarks, service marks or logos of Apple Inc. may<span></span></pre></td></tr><tr><td scope="row"><pre> be used to endorse or promote products derived from the Apple Software<span></span></pre></td></tr><tr><td scope="row"><pre> without specific prior written permission from Apple.  Except as<span></span></pre></td></tr><tr><td scope="row"><pre> expressly stated in this notice, no other rights or licenses, express or<span></span></pre></td></tr><tr><td scope="row"><pre> implied, are granted by Apple herein, including but not limited to any<span></span></pre></td></tr><tr><td scope="row"><pre> patent rights that may be infringed by your derivative works or by other<span></span></pre></td></tr><tr><td scope="row"><pre> works in which the Apple Software may be incorporated.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> The Apple Software is provided by Apple on an "AS IS" basis.  APPLE<span></span></pre></td></tr><tr><td scope="row"><pre> MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION<span></span></pre></td></tr><tr><td scope="row"><pre> THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS<span></span></pre></td></tr><tr><td scope="row"><pre> FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND<span></span></pre></td></tr><tr><td scope="row"><pre> OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL<span></span></pre></td></tr><tr><td scope="row"><pre> OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<span></span></pre></td></tr><tr><td scope="row"><pre> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<span></span></pre></td></tr><tr><td scope="row"><pre> INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,<span></span></pre></td></tr><tr><td scope="row"><pre> MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED<span></span></pre></td></tr><tr><td scope="row"><pre> AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE),<span></span></pre></td></tr><tr><td scope="row"><pre> STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE<span></span></pre></td></tr><tr><td scope="row"><pre> POSSIBILITY OF SUCH DAMAGE.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> Copyright (C) 2011 Apple Inc. All Rights Reserved.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#import "RegionsViewController.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#import "RegionAnnotationView.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#import "RegionAnnotation.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@implementation RegionsViewController<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@synthesize regionsMapView, updatesTableView, updateEvents, locationManager, navigationBar;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - Memory management<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)didReceiveMemoryWarning {<span></span></pre></td></tr><tr><td scope="row"><pre>    [super didReceiveMemoryWarning];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)dealloc {<span></span></pre></td></tr><tr><td scope="row"><pre>    [updateEvents release];<span></span></pre></td></tr><tr><td scope="row"><pre>    self.locationManager.delegate = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [regionsMapView release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [updatesTableView release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [navigationBar release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [super dealloc];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - View lifecycle<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)viewDidLoad {<span></span></pre></td></tr><tr><td scope="row"><pre>    [super viewDidLoad];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create empty array to add region events to.<span></span></pre></td></tr><tr><td scope="row"><pre>    updateEvents = [[NSMutableArray alloc] initWithCapacity:0];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create location manager with filters set for battery efficiency.<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager = [[CLLocationManager alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager.delegate = self;<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager.distanceFilter = kCLLocationAccuracyHundredMeters;<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager.desiredAccuracy = kCLLocationAccuracyBest;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Start updating location changes.<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager startUpdatingLocation];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)viewDidAppear:(BOOL)animated {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Get all regions being monitored for this application.<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *regions = [[locationManager monitoredRegions] allObjects];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Iterate through the regions and add annotations to the map for each of them.<span></span></pre></td></tr><tr><td scope="row"><pre>    for (int i = 0; i &lt; [regions count]; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        CLRegion *region = [regions objectAtIndex:i];<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotation *annotation = [[RegionAnnotation alloc] initWithCLRegion:region];<span></span></pre></td></tr><tr><td scope="row"><pre>        [regionsMapView addAnnotation:annotation];<span></span></pre></td></tr><tr><td scope="row"><pre>        [annotation release];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)viewDidUnload {<span></span></pre></td></tr><tr><td scope="row"><pre>    self.updateEvents = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.locationManager.delegate = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.locationManager = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.regionsMapView = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.updatesTableView = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.navigationBar = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Return YES for supported orientations<span></span></pre></td></tr><tr><td scope="row"><pre>    return (interfaceOrientation == UIInterfaceOrientationPortrait);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - UITableViewDelegate<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {<span></span></pre></td></tr><tr><td scope="row"><pre>    return 1;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {<span></span></pre></td></tr><tr><td scope="row"><pre>    return [updateEvents count];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {    <span></span></pre></td></tr><tr><td scope="row"><pre>    static NSString *cellIdentifier = @"Cell";<span></span></pre></td></tr><tr><td scope="row"><pre>    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellIdentifier];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    if (cell == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        cell = [[[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellIdentifier] autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    cell.textLabel.font = [UIFont systemFontOfSize:12.0];<span></span></pre></td></tr><tr><td scope="row"><pre>    cell.textLabel.text = [updateEvents objectAtIndex:indexPath.row];<span></span></pre></td></tr><tr><td scope="row"><pre>    cell.textLabel.numberOfLines = 4;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    return cell;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {<span></span></pre></td></tr><tr><td scope="row"><pre>    return 60.0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - MKMapViewDelegate<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (MKAnnotationView *)mapView:(MKMapView *)mapView viewForAnnotation:(id &lt;MKAnnotation&gt;)annotation {    <span></span></pre></td></tr><tr><td scope="row"><pre>    if([annotation isKindOfClass:[RegionAnnotation class]]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotation *currentAnnotation = (RegionAnnotation *)annotation;<span></span></pre></td></tr><tr><td scope="row"><pre>        NSString *annotationIdentifier = [currentAnnotation title];<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotationView *regionView = (RegionAnnotationView *)[regionsMapView dequeueReusableAnnotationViewWithIdentifier:annotationIdentifier];   <span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        if (!regionView) {<span></span></pre></td></tr><tr><td scope="row"><pre>            regionView = [[[RegionAnnotationView alloc] initWithAnnotation:annotation] autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>            regionView.map = regionsMapView;<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>            // Create a button for the left callout accessory view of each annotation to remove the annotation and region being monitored.<span></span></pre></td></tr><tr><td scope="row"><pre>            UIButton *removeRegionButton = [UIButton buttonWithType:UIButtonTypeCustom];<span></span></pre></td></tr><tr><td scope="row"><pre>            [removeRegionButton setFrame:CGRectMake(0., 0., 25., 25.)];<span></span></pre></td></tr><tr><td scope="row"><pre>            [removeRegionButton setImage:[UIImage imageNamed:@"RemoveRegion"] forState:UIControlStateNormal];<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>            regionView.leftCalloutAccessoryView = removeRegionButton;<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {        <span></span></pre></td></tr><tr><td scope="row"><pre>            regionView.annotation = annotation;<span></span></pre></td></tr><tr><td scope="row"><pre>            regionView.theAnnotation = annotation;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // Update or add the overlay displaying the radius of the region around the annotation.<span></span></pre></td></tr><tr><td scope="row"><pre>        [regionView updateRadiusOverlay];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        return regionView;      <span></span></pre></td></tr><tr><td scope="row"><pre>    }   <span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    return nil; <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (MKOverlayView *)mapView:(MKMapView *)mapView viewForOverlay:(id &lt;MKOverlay&gt;)overlay {<span></span></pre></td></tr><tr><td scope="row"><pre>    if([overlay isKindOfClass:[MKCircle class]]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Create the view for the radius overlay.<span></span></pre></td></tr><tr><td scope="row"><pre>        MKCircleView *circleView = [[[MKCircleView alloc] initWithOverlay:overlay] autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>        circleView.strokeColor = [UIColor purpleColor];<span></span></pre></td></tr><tr><td scope="row"><pre>        circleView.fillColor = [[UIColor purpleColor] colorWithAlphaComponent:0.4];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        return circleView;      <span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    return nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)mapView:(MKMapView *)mapView annotationView:(MKAnnotationView *)annotationView didChangeDragState:(MKAnnotationViewDragState)newState fromOldState:(MKAnnotationViewDragState)oldState {<span></span></pre></td></tr><tr><td scope="row"><pre>    if([annotationView isKindOfClass:[RegionAnnotationView class]]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotationView *regionView = (RegionAnnotationView *)annotationView;<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotation *regionAnnotation = (RegionAnnotation *)regionView.annotation;<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // If the annotation view is starting to be dragged, remove the overlay and stop monitoring the region.<span></span></pre></td></tr><tr><td scope="row"><pre>        if (newState == MKAnnotationViewDragStateStarting) {        <span></span></pre></td></tr><tr><td scope="row"><pre>            [regionView removeRadiusOverlay];<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>            [locationManager stopMonitoringForRegion:regionAnnotation.region];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // Once the annotation view has been dragged and placed in a new location, update and add the overlay and begin monitoring the new region.<span></span></pre></td></tr><tr><td scope="row"><pre>        if (oldState == MKAnnotationViewDragStateDragging &amp;&amp; newState == MKAnnotationViewDragStateEnding) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [regionView updateRadiusOverlay];<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>            CLRegion *newRegion = [[CLRegion alloc] initCircularRegionWithCenter:regionAnnotation.coordinate radius:1000.0 identifier:[NSString stringWithFormat:@"%f, %f", regionAnnotation.coordinate.latitude, regionAnnotation.coordinate.longitude]];<span></span></pre></td></tr><tr><td scope="row"><pre>            regionAnnotation.region = newRegion;<span></span></pre></td></tr><tr><td scope="row"><pre>            [newRegion release];<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>            [locationManager startMonitoringForRegion:regionAnnotation.region desiredAccuracy:kCLLocationAccuracyBest];<span></span></pre></td></tr><tr><td scope="row"><pre>        }       <span></span></pre></td></tr><tr><td scope="row"><pre>    }   <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)mapView:(MKMapView *)mapView annotationView:(MKAnnotationView *)view calloutAccessoryControlTapped:(UIControl *)control {<span></span></pre></td></tr><tr><td scope="row"><pre>    RegionAnnotationView *regionView = (RegionAnnotationView *)view;<span></span></pre></td></tr><tr><td scope="row"><pre>    RegionAnnotation *regionAnnotation = (RegionAnnotation *)regionView.annotation;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Stop monitoring the region, remove the radius overlay, and finally remove the annotation from the map.<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager stopMonitoringForRegion:regionAnnotation.region];<span></span></pre></td></tr><tr><td scope="row"><pre>    [regionView removeRadiusOverlay];<span></span></pre></td></tr><tr><td scope="row"><pre>    [regionsMapView removeAnnotation:regionAnnotation];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - CLLocationManagerDelegate<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didFailWithError:(NSError *)error {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSLog(@"didFailWithError: %@", error);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSLog(@"didUpdateToLocation %@ from %@", newLocation, oldLocation);<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Work around a bug in MapKit where user location is not initially zoomed to.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (oldLocation == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Zoom to the current user location.<span></span></pre></td></tr><tr><td scope="row"><pre>        MKCoordinateRegion userLocation = MKCoordinateRegionMakeWithDistance(newLocation.coordinate, 1500.0, 1500.0);<span></span></pre></td></tr><tr><td scope="row"><pre>        [regionsMapView setRegion:userLocation animated:YES];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didEnterRegion:(CLRegion *)region  {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *event = [NSString stringWithFormat:@"didEnterRegion %@ at %@", region.identifier, [NSDate date]];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    [self updateWithEvent:event];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didExitRegion:(CLRegion *)region {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *event = [NSString stringWithFormat:@"didExitRegion %@ at %@", region.identifier, [NSDate date]];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    [self updateWithEvent:event];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager monitoringDidFailForRegion:(CLRegion *)region withError:(NSError *)error {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *event = [NSString stringWithFormat:@"monitoringDidFailForRegion %@: %@", region.identifier, error];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    [self updateWithEvent:event];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark - RegionsViewController<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*<span></span></pre></td></tr><tr><td scope="row"><pre> This method swaps the visibility of the map view and the table of region events.<span></span></pre></td></tr><tr><td scope="row"><pre> The "add region" button in the navigation bar is also altered to only be enabled when the map is shown.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)switchViews {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Swap the hidden status of the map and table view so that the appropriate one is now showing.<span></span></pre></td></tr><tr><td scope="row"><pre>    self.regionsMapView.hidden = !self.regionsMapView.hidden;<span></span></pre></td></tr><tr><td scope="row"><pre>    self.updatesTableView.hidden = !self.updatesTableView.hidden;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Adjust the "add region" button to only be enabled when the map is shown.<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *navigationBarItems = [NSArray arrayWithArray:self.navigationBar.items];<span></span></pre></td></tr><tr><td scope="row"><pre>    UIBarButtonItem *addRegionButton = [[navigationBarItems objectAtIndex:0] rightBarButtonItem];<span></span></pre></td></tr><tr><td scope="row"><pre>    addRegionButton.enabled = !addRegionButton.enabled;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Reload the table data and update the icon badge number when the table view is shown.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!updatesTableView.hidden) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [updatesTableView reloadData];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*<span></span></pre></td></tr><tr><td scope="row"><pre> This method creates a new region based on the center coordinate of the map view.<span></span></pre></td></tr><tr><td scope="row"><pre> A new annotation is created to represent the region and then the application starts monitoring the new region.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)addRegion {<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([CLLocationManager regionMonitoringAvailable]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Create a new region based on the center of the map view.<span></span></pre></td></tr><tr><td scope="row"><pre>        CLLocationCoordinate2D coord = CLLocationCoordinate2DMake(regionsMapView.centerCoordinate.latitude, regionsMapView.centerCoordinate.longitude);<span></span></pre></td></tr><tr><td scope="row"><pre>        CLRegion *newRegion = [[CLRegion alloc] initCircularRegionWithCenter:coord <span></span></pre></td></tr><tr><td scope="row"><pre>                                                                      radius:1000.0 <span></span></pre></td></tr><tr><td scope="row"><pre>                                                                  identifier:[NSString stringWithFormat:@"%f, %f", regionsMapView.centerCoordinate.latitude, regionsMapView.centerCoordinate.longitude]];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // Create an annotation to show where the region is located on the map.<span></span></pre></td></tr><tr><td scope="row"><pre>        RegionAnnotation *myRegionAnnotation = [[RegionAnnotation alloc] initWithCLRegion:newRegion];<span></span></pre></td></tr><tr><td scope="row"><pre>        myRegionAnnotation.coordinate = newRegion.center;<span></span></pre></td></tr><tr><td scope="row"><pre>        myRegionAnnotation.radius = newRegion.radius;<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        [regionsMapView addAnnotation:myRegionAnnotation];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        [myRegionAnnotation release];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // Start monitoring the newly created region.<span></span></pre></td></tr><tr><td scope="row"><pre>        [locationManager startMonitoringForRegion:newRegion desiredAccuracy:kCLLocationAccuracyBest];<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        [newRegion release];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSLog(@"Region monitoring is not available.");<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*<span></span></pre></td></tr><tr><td scope="row"><pre> This method adds the region event to the events array and updates the icon badge number.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)updateWithEvent:(NSString *)event {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Add region event to the updates array.<span></span></pre></td></tr><tr><td scope="row"><pre>    [updateEvents insertObject:event atIndex:0];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Update the icon badge number.<span></span></pre></td></tr><tr><td scope="row"><pre>    [UIApplication sharedApplication].applicationIconBadgeNumber++;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    if (!updatesTableView.hidden) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [updatesTableView reloadData];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div>

        <div id="pageNavigationLinks_bottom" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='../History/History.html'>Next</a><a class='previousLink' rel='prev' href='Regions_RegionsViewController_h.html'>Previous</a>
        </div><br/>
        <div class="copyright"><br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> Copyright &#x00a9; 2011 Apple Inc. All Rights Reserved. <a href="http://www.apple.com/legal/internet-services/terms/site.html" target="_blank">Terms of Use</a>   |  <a href="http://www.apple.com/privacy/" target="_blank">Privacy Policy</a>  |  Updated: 2011-03-23</p></div></div>

        <div id="pediaWindow">
            <div id="pediaHeader"></div>
            <div id="pediaBody"></div>
        </div>
    </article>

    <div id="blackout">
    <div id="preload"></div>
</div>
<div id="leave_feedback" class="button" role="button" tabindex="0">Feedback</div>
<div id="modal" aria-hidden="true">
    <div id="closebox" tabindex="0" aria-label="Close feedback form" role="button"></div>
    <div id="sending" class="hidden">
        <h2 tabindex="0">Sending feedback&hellip;</h2>
        <div id="sending_img"></div>
    </div>
    <div id="error" class="hidden">
        <h2 tabindex="0">We&rsquo;re sorry, an error has occurred.</h2>
        <p>Please try submitting your feedback later.</p>
        <div id="error_icon"></div>
    </div>
    <div id="success" class="hidden">
        <h2 tabindex="0">Thank you for providing feedback!</h2>
        <p>Your input helps improve our developer documentation.</p>
        <div id="thank_you_icon"></div>
    </div>
    
    <form id="feedback" action="#" method="post">
        <div class="left-leaf">
            <h2 id="helpful_title" data-asterisk="a1" tabindex="0">How helpful is this document?</h2>     
            <sup id="a1" class="asterisk" aria-hidden="true">*</sup>

            <div id="star_group" role="radiogroup" aria-required="true">
                <label> 
                    <input class="radio" type="radio" name="helped" value="1" /> 
                    Very helpful
                </label>
                <label> 
                    <input class="radio" type="radio" name="helped" value="2" /> 
                    Somewhat helpful
                </label>
                <label>
                    <input class="radio" type="radio" name="helped" value="3" /> 
                    Not helpful
                </label>
            </div>
        </div>
        <div class="right-leaf">
            <h2>How can we improve this document?</h2>
            <div id="improve" class="checkboxes">
                <label>
                    <input type="checkbox" name="typo" /> 
                    Fix typos or links
                </label>
                <label>
                    <input type="checkbox" name="infoIncorrect" /> 
                    Fix incorrect information
                </label>
                <label>
                    <input type="checkbox" name="needs_examples" /> 
                    Add or update code samples
                </label>
                <label>
                    <input type="checkbox" name="needs_art" /> 
                    Add or update illustrations
                </label>
                <label>
                    <input type="checkbox" name="missingInfo" /> 
                    Add information about...
                </label>
            </div>
        </div>

        <textarea id="comment" name="problem" cols="70" rows="8" placeholder="Please tell us more about your experience with this document" data-asterisk="a2" required></textarea>
        <sup id="a2" class="asterisk" aria-hidden="true">*</sup>

        <input id="email" type="email" name="email" placeholder="Email (optional)" size="48">

        <p class="fineprint">
            <em aria-hidden="true"><span>*</span> Required information</em>
        </p> 

        <input id="submit" type="button" value="Send" />

        <section id="legal">
            <p>
                To submit a product bug or enhancement request, please visit the 
                <a href="../../../../../bug-reporting/index.html" target="_blank">Bug Reporter</a> 
                page.
            </p>
            <p>
                Please read <a href="http://www.apple.com/legal/policies/ideas.html" target="_blank">Apple's Unsolicited Idea Submission Policy</a> 
                before you send us your feedback.
            </p> 
        </section>
    </form>
</div>

    
    <script charset="utf-8" src="../../../Resources/874/JavaScript/lib/prototype.js"></script>
    <script src="../../../Resources/874/JavaScript/library.js"></script>
    <script src="../../../Resources/874/JavaScript/feedback.js"></script>
</body>
<script type="text/javascript" src="../../../../webstats/pagetracker.js"></script>
<script type="text/javascript">
if(typeof PageTracker !== 'undefined') {
  if(window.addEventListener) {
    window.addEventListener("load", function(){PageTracker.logPageLoad()},false);
  } else if(window.attachEvent) {
    window.attachEvent("onload",function(){PageTracker.logPageLoad()});
  }
}
</script>
</html>
