<!DOCTYPE html>
<html lang="en">
<head>
    <title>pARk: pARk/ARView.m</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta charset="utf-8">
    <meta id="book-resource-type" name="book-resource-type" content="Sample Code">
    <meta scheme="apple_ref" id="identifier" name="identifier" content="//apple_ref/doc/uid/DTS40011083">
	<meta id="document-version" name="document-version" content="1.2.0">
    <meta id="build" name="build" content="bcf073e0579478458b78c3b3068a2133">
    <meta id="chapterId" name="chapterId" content="DTS40011083-pARk_ARView_m">
    <meta id="date" name="date" content="2012-06-26">
    <meta id="description" name="description" content="Demonstrates features of Core Motion by displaying a live camera feed using AVFoundation with places-of-interest overlaid at the appropriate coordinates.">
    <meta id="book-title" name="book-title" content="pARk">
    <meta id="book-name" name="book-name" content="DTS_SC2153_pARk">
    <meta id="book-root" name="book-root" content="../">
    <meta id="book-json" name="book-json" content="../book.json">
    <meta id="devcenter" name="devcenter" content="iOS Dev Center">
    <meta id="devcenter-url" name="devcenter-url" content="http://developer.apple.com/devcenter/ios">
    <meta id="reflib" name="reflib" content="iOS Developer Library">
    <meta id="book-assignments" name="book-assignments" content="{Type/Sample Code}, {Framework/Core Services Layer/CoreMotion}, {Topic/Data Management/Event Handling}">
    
    
    <meta id="generator" name="generator" content="Gutenberg 003a3034">
    <meta name='numbat' content='aa879094b666337fdcde744b62fbff30'>
    <meta id="copyright" name="copyright" content="Copyright 2014 Apple Inc. All Rights Reserved.">
    <meta id="xcode-display" name="xcode-display" content="render">
    <meta id="IndexTitle" name="IndexTitle" content="pARk/ARView.m">
    <meta id="resources-uri" name="resources-uri" content="../../../Resources/874">
    <link id="book-index-page" rel="Start" title="pARk" type="text/html" href="../index.html">
    <link id="next-page" rel="Next" type="text/html" href="https://developer.apple.com/library/ios/samplecode/pARk/Listings/pARk_main_m.html">
    <link id="previous-page" rel="Prev" type="text/html" href="pARk_ARView_h.html">
    <link rel="stylesheet" type="text/css" href="../../../Resources/874/CSS/screen.css">
    
    <link rel="stylesheet" type="text/css" href="../../../Resources/874/CSS/feedback.css">
</head>    
<body><a name="//apple_ref/doc/uid/DTS40011083-pARk_ARView_m" title="pARk/ARView.m"></a>
    <div id="adcHeader" class="hideOnPrint hideInXcode">
        <div id='ssi_Header' class="hideInXcode phone">
            <a id="ssi_LibraryTitle" href='../../../navigation/index.html'>iOS Developer Library</a>
            <a id="ssi_AppleDeveloperConnection" href='../../../../../index.html'>Developer</a>
            <div id='ssi_SearchButton' role="button" title="Search">Search</div>
        </div>
        <form id='ssi_SearchMenu' method='get' action='../../../search/' accept-charset='utf-8'>
            <label for='adcsearch'>Search iOS Developer Library</label>
            <input type='search' id='ssi_SearchField' name='q' accesskey='s' results='5' />
        </form>
    </div>

    <header id="header">
        <div id="title" role="banner">
            <h1>pARk</h1>
            <span id="file_links">
                <a id="PDF_link" role="button" tabindex='4' rel="alternate" title="Download PDF"><span id="pdf_icon"></span>PDF</a>
                <a id="Companion_link" role="button" tabindex='3' title="Download Companion File"><span id="companion_icon"></span>Companion File</a>
            </span>
        </div>
        <ul id="headerButtons" class="hideOnPrint" role="toolbar">
            <li id="toc_button" style="display:none">
                <button tabindex="5" id="table_of_contents" class="open" role="checkbox" aria-label="Show Table of Contents"><span class="disclosure"></span>Table of Contents</button>
            </li>
            <li id="jumpto_button" style="display:none" role="navigation"><select tabindex="6" id="jumpTo"><option value="top">Jump To&#133;</option></select></li>
            <li id="downloadSample_button" style="display:none">
                <a id="Sample_link"><button id="Sample_button">Download Sample Code</button></a>
            </li>
        </ul>
    </header>
    <nav id="tocContainer" tabindex="7">
        <ul id="toc" role="tree"></ul>
    </nav>

    <article id="contents" tabindex="0" role="main">
        <div id="pageNavigationLinks_top" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='https://developer.apple.com/library/ios/samplecode/pARk/Listings/pARk_main_m.html'>Next</a><a class='previousLink' rel='prev' href='pARk_ARView_h.html'>Previous</a>
        </div>
        <a id="top" name="top"></a>
        <a id="INDEX" href="../index.html" style="display:none;"></a>
        
        <a name="//apple_ref/doc/uid/DTS40011083-pARk_ARView_m-DontLinkElementID_5" title="pARk/ARView.m"></a>
    <h1 id="pageTitle">pARk/ARView.m</h1>
    <div class="codesample clear"><table><tr><td scope="row"><pre>/*<span></span></pre></td></tr><tr><td scope="row"><pre>     File: ARView.m<span></span></pre></td></tr><tr><td scope="row"><pre> Abstract: Augmented reality view. Displays a live camera feed with specified places-of-interest overlayed in the correct position based on the direction the user is looking. Uses Core Location to determine the user's location relative the places-of-interest and Core Motion to determine the direction the user is looking.<span></span></pre></td></tr><tr><td scope="row"><pre>  Version: 1.0<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple<span></span></pre></td></tr><tr><td scope="row"><pre> Inc. ("Apple") in consideration of your agreement to the following<span></span></pre></td></tr><tr><td scope="row"><pre> terms, and your use, installation, modification or redistribution of<span></span></pre></td></tr><tr><td scope="row"><pre> this Apple software constitutes acceptance of these terms.  If you do<span></span></pre></td></tr><tr><td scope="row"><pre> not agree with these terms, please do not use, install, modify or<span></span></pre></td></tr><tr><td scope="row"><pre> redistribute this Apple software.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> In consideration of your agreement to abide by the following terms, and<span></span></pre></td></tr><tr><td scope="row"><pre> subject to these terms, Apple grants you a personal, non-exclusive<span></span></pre></td></tr><tr><td scope="row"><pre> license, under Apple's copyrights in this original Apple software (the<span></span></pre></td></tr><tr><td scope="row"><pre> "Apple Software"), to use, reproduce, modify and redistribute the Apple<span></span></pre></td></tr><tr><td scope="row"><pre> Software, with or without modifications, in source and/or binary forms;<span></span></pre></td></tr><tr><td scope="row"><pre> provided that if you redistribute the Apple Software in its entirety and<span></span></pre></td></tr><tr><td scope="row"><pre> without modifications, you must retain this notice and the following<span></span></pre></td></tr><tr><td scope="row"><pre> text and disclaimers in all such redistributions of the Apple Software.<span></span></pre></td></tr><tr><td scope="row"><pre> Neither the name, trademarks, service marks or logos of Apple Inc. may<span></span></pre></td></tr><tr><td scope="row"><pre> be used to endorse or promote products derived from the Apple Software<span></span></pre></td></tr><tr><td scope="row"><pre> without specific prior written permission from Apple.  Except as<span></span></pre></td></tr><tr><td scope="row"><pre> expressly stated in this notice, no other rights or licenses, express or<span></span></pre></td></tr><tr><td scope="row"><pre> implied, are granted by Apple herein, including but not limited to any<span></span></pre></td></tr><tr><td scope="row"><pre> patent rights that may be infringed by your derivative works or by other<span></span></pre></td></tr><tr><td scope="row"><pre> works in which the Apple Software may be incorporated.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> The Apple Software is provided by Apple on an "AS IS" basis.  APPLE<span></span></pre></td></tr><tr><td scope="row"><pre> MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION<span></span></pre></td></tr><tr><td scope="row"><pre> THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS<span></span></pre></td></tr><tr><td scope="row"><pre> FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND<span></span></pre></td></tr><tr><td scope="row"><pre> OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL<span></span></pre></td></tr><tr><td scope="row"><pre> OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<span></span></pre></td></tr><tr><td scope="row"><pre> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<span></span></pre></td></tr><tr><td scope="row"><pre> INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,<span></span></pre></td></tr><tr><td scope="row"><pre> MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED<span></span></pre></td></tr><tr><td scope="row"><pre> AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE),<span></span></pre></td></tr><tr><td scope="row"><pre> STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE<span></span></pre></td></tr><tr><td scope="row"><pre> POSSIBILITY OF SUCH DAMAGE.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> Copyright (C) 2012 Apple Inc. All Rights Reserved.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#import "ARView.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#import "PlaceOfInterest.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#import &lt;AVFoundation/AVFoundation.h&gt;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark Math utilities declaration<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define DEGREES_TO_RADIANS (M_PI/180.0)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef float mat4f_t[16];  // 4x4 matrix in column major order<span></span></pre></td></tr><tr><td scope="row"><pre>typedef float vec4f_t[4];   // 4D vector<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Creates a projection matrix using the given y-axis field-of-view, aspect ratio, and near and far clipping planes<span></span></pre></td></tr><tr><td scope="row"><pre>void createProjectionMatrix(mat4f_t mout, float fovy, float aspect, float zNear, float zFar);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Matrix-vector and matrix-matricx multiplication routines<span></span></pre></td></tr><tr><td scope="row"><pre>void multiplyMatrixAndVector(vec4f_t vout, const mat4f_t m, const vec4f_t v);<span></span></pre></td></tr><tr><td scope="row"><pre>void multiplyMatrixAndMatrix(mat4f_t c, const mat4f_t a, const mat4f_t b);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Initialize mout to be an affine transform corresponding to the same rotation specified by m<span></span></pre></td></tr><tr><td scope="row"><pre>void transformFromCMRotationMatrix(vec4f_t mout, const CMRotationMatrix *m);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark Geodetic utilities declaration<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define WGS84_A (6378137.0)             // WGS 84 semi-major axis constant in meters<span></span></pre></td></tr><tr><td scope="row"><pre>#define WGS84_E (8.1819190842622e-2)    // WGS 84 eccentricity<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Converts latitude, longitude to ECEF coordinate system<span></span></pre></td></tr><tr><td scope="row"><pre>void latLonToEcef(double lat, double lon, double alt, double *x, double *y, double *z);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Coverts ECEF to ENU coordinates centered at given lat, lon<span></span></pre></td></tr><tr><td scope="row"><pre>void ecefToEnu(double lat, double lon, double x, double y, double z, double xr, double yr, double zr, double *e, double *n, double *u);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark ARView extension<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@interface ARView () {<span></span></pre></td></tr><tr><td scope="row"><pre>    UIView *captureView;<span></span></pre></td></tr><tr><td scope="row"><pre>    AVCaptureSession *captureSession;<span></span></pre></td></tr><tr><td scope="row"><pre>    AVCaptureVideoPreviewLayer *captureLayer;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    CADisplayLink *displayLink;<span></span></pre></td></tr><tr><td scope="row"><pre>    CMMotionManager *motionManager;<span></span></pre></td></tr><tr><td scope="row"><pre>    CLLocationManager *locationManager;<span></span></pre></td></tr><tr><td scope="row"><pre>    CLLocation *location;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *placesOfInterest;<span></span></pre></td></tr><tr><td scope="row"><pre>    mat4f_t projectionTransform;<span></span></pre></td></tr><tr><td scope="row"><pre>    mat4f_t cameraTransform;    <span></span></pre></td></tr><tr><td scope="row"><pre>    vec4f_t *placesOfInterestCoordinates;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)initialize;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startCameraPreview;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopCameraPreview;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startLocation;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopLocation;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startDeviceMotion;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopDeviceMotion;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startDisplayLink;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopDisplayLink;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)updatePlacesOfInterestCoordinates;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)onDisplayLink:(id)sender;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark ARView implementation<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@implementation ARView<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@dynamic placesOfInterest;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)dealloc<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self stop];<span></span></pre></td></tr><tr><td scope="row"><pre>    [placesOfInterest release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [location release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureView removeFromSuperview];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureView release];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (placesOfInterestCoordinates != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        free(placesOfInterestCoordinates);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    [super dealloc];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)start<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self startCameraPreview];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self startLocation];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self startDeviceMotion];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self startDisplayLink];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stop<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self stopCameraPreview];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self stopLocation];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self stopDeviceMotion];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self stopDisplayLink];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setPlacesOfInterest:(NSArray *)pois<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    for (PlaceOfInterest *poi in [placesOfInterest objectEnumerator]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [poi.view removeFromSuperview];<span></span></pre></td></tr><tr><td scope="row"><pre>    }   <span></span></pre></td></tr><tr><td scope="row"><pre>    [placesOfInterest release];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    placesOfInterest = [pois retain];   <span></span></pre></td></tr><tr><td scope="row"><pre>    if (location != nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [self updatePlacesOfInterestCoordinates];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (NSArray *)placesOfInterest<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return placesOfInterest;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)initialize<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    captureView = [[UIView alloc] initWithFrame:self.bounds];<span></span></pre></td></tr><tr><td scope="row"><pre>    captureView.bounds = self.bounds;<span></span></pre></td></tr><tr><td scope="row"><pre>    [self addSubview:captureView];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self sendSubviewToBack:captureView];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Initialize projection matrix <span></span></pre></td></tr><tr><td scope="row"><pre>    createProjectionMatrix(projectionTransform, 60.0f*DEGREES_TO_RADIANS, self.bounds.size.width*1.0f / self.bounds.size.height, 0.25f, 1000.0f);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startCameraPreview<span></span></pre></td></tr><tr><td scope="row"><pre>{   <span></span></pre></td></tr><tr><td scope="row"><pre>    AVCaptureDevice* camera = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (camera == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        return;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    captureSession = [[AVCaptureSession alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    AVCaptureDeviceInput *newVideoInput = [[[AVCaptureDeviceInput alloc] initWithDevice:camera error:nil] autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureSession addInput:newVideoInput];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    captureLayer = [[AVCaptureVideoPreviewLayer alloc] initWithSession:captureSession];<span></span></pre></td></tr><tr><td scope="row"><pre>    captureLayer.frame = captureView.bounds;<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureLayer setOrientation:AVCaptureVideoOrientationPortrait];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureLayer setVideoGravity:AVLayerVideoGravityResizeAspectFill];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureView.layer addSublayer:captureLayer];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Start the session. This is done asychronously since -startRunning doesn't return until the session is running.<span></span></pre></td></tr><tr><td scope="row"><pre>    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{<span></span></pre></td></tr><tr><td scope="row"><pre>        [captureSession startRunning];<span></span></pre></td></tr><tr><td scope="row"><pre>    });<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopCameraPreview<span></span></pre></td></tr><tr><td scope="row"><pre>{   <span></span></pre></td></tr><tr><td scope="row"><pre>    [captureSession stopRunning];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureLayer removeFromSuperlayer];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureSession release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [captureLayer release];<span></span></pre></td></tr><tr><td scope="row"><pre>    captureSession = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    captureLayer = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startLocation<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager release];<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager = [[CLLocationManager alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager.delegate = self;<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager.distanceFilter = 100.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager startUpdatingLocation];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopLocation<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager stopUpdatingLocation];<span></span></pre></td></tr><tr><td scope="row"><pre>    [locationManager release];<span></span></pre></td></tr><tr><td scope="row"><pre>    locationManager = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startDeviceMotion<span></span></pre></td></tr><tr><td scope="row"><pre>{   <span></span></pre></td></tr><tr><td scope="row"><pre>    motionManager = [[CMMotionManager alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Tell CoreMotion to show the compass calibration HUD when required to provide true north-referenced attitude<span></span></pre></td></tr><tr><td scope="row"><pre>    motionManager.showsDeviceMovementDisplay = YES;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    motionManager.deviceMotionUpdateInterval = 1.0 / 60.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // New in iOS 5.0: Attitude that is referenced to true north<span></span></pre></td></tr><tr><td scope="row"><pre>    [motionManager startDeviceMotionUpdatesUsingReferenceFrame:CMAttitudeReferenceFrameXTrueNorthZVertical];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopDeviceMotion<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [motionManager stopDeviceMotionUpdates];<span></span></pre></td></tr><tr><td scope="row"><pre>    [motionManager release];<span></span></pre></td></tr><tr><td scope="row"><pre>    motionManager = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)startDisplayLink<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    displayLink = [[CADisplayLink displayLinkWithTarget:self selector:@selector(onDisplayLink:)] retain];<span></span></pre></td></tr><tr><td scope="row"><pre>    [displayLink setFrameInterval:1];<span></span></pre></td></tr><tr><td scope="row"><pre>    [displayLink addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSDefaultRunLoopMode];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)stopDisplayLink<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [displayLink invalidate];<span></span></pre></td></tr><tr><td scope="row"><pre>    [displayLink release];<span></span></pre></td></tr><tr><td scope="row"><pre>    displayLink = nil;      <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)updatePlacesOfInterestCoordinates<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    if (placesOfInterestCoordinates != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        free(placesOfInterestCoordinates);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    placesOfInterestCoordinates = (vec4f_t *)malloc(sizeof(vec4f_t)*placesOfInterest.count);<span></span></pre></td></tr><tr><td scope="row"><pre>            <span></span></pre></td></tr><tr><td scope="row"><pre>    int i = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    double myX, myY, myZ;<span></span></pre></td></tr><tr><td scope="row"><pre>    latLonToEcef(location.coordinate.latitude, location.coordinate.longitude, 0.0, &amp;myX, &amp;myY, &amp;myZ);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Array of NSData instances, each of which contains a struct with the distance to a POI and the<span></span></pre></td></tr><tr><td scope="row"><pre>    // POI's index into placesOfInterest<span></span></pre></td></tr><tr><td scope="row"><pre>    // Will be used to ensure proper Z-ordering of UIViews<span></span></pre></td></tr><tr><td scope="row"><pre>    typedef struct {<span></span></pre></td></tr><tr><td scope="row"><pre>        float distance;<span></span></pre></td></tr><tr><td scope="row"><pre>        int index;<span></span></pre></td></tr><tr><td scope="row"><pre>    } DistanceAndIndex;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableArray *orderedDistances = [NSMutableArray arrayWithCapacity:placesOfInterest.count];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Compute the world coordinates of each place-of-interest<span></span></pre></td></tr><tr><td scope="row"><pre>    for (PlaceOfInterest *poi in [[self placesOfInterest] objectEnumerator]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        double poiX, poiY, poiZ, e, n, u;<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        latLonToEcef(poi.location.coordinate.latitude, poi.location.coordinate.longitude, 0.0, &amp;poiX, &amp;poiY, &amp;poiZ);<span></span></pre></td></tr><tr><td scope="row"><pre>        ecefToEnu(location.coordinate.latitude, location.coordinate.longitude, myX, myY, myZ, poiX, poiY, poiZ, &amp;e, &amp;n, &amp;u);<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        placesOfInterestCoordinates[i][0] = (float)n;<span></span></pre></td></tr><tr><td scope="row"><pre>        placesOfInterestCoordinates[i][1]= -(float)e;<span></span></pre></td></tr><tr><td scope="row"><pre>        placesOfInterestCoordinates[i][2] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>        placesOfInterestCoordinates[i][3] = 1.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        // Add struct containing distance and index to orderedDistances<span></span></pre></td></tr><tr><td scope="row"><pre>        DistanceAndIndex distanceAndIndex;<span></span></pre></td></tr><tr><td scope="row"><pre>        distanceAndIndex.distance = sqrtf(n*n + e*e);<span></span></pre></td></tr><tr><td scope="row"><pre>        distanceAndIndex.index = i;<span></span></pre></td></tr><tr><td scope="row"><pre>        [orderedDistances insertObject:[NSData dataWithBytes:&amp;distanceAndIndex length:sizeof(distanceAndIndex)] atIndex:i++];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Sort orderedDistances in ascending order based on distance from the user<span></span></pre></td></tr><tr><td scope="row"><pre>    [orderedDistances sortUsingComparator:(NSComparator)^(NSData *a, NSData *b) {<span></span></pre></td></tr><tr><td scope="row"><pre>        const DistanceAndIndex *aData = (const DistanceAndIndex *)a.bytes;<span></span></pre></td></tr><tr><td scope="row"><pre>        const DistanceAndIndex *bData = (const DistanceAndIndex *)b.bytes;<span></span></pre></td></tr><tr><td scope="row"><pre>        if (aData-&gt;distance &lt; bData-&gt;distance) {<span></span></pre></td></tr><tr><td scope="row"><pre>            return NSOrderedAscending;<span></span></pre></td></tr><tr><td scope="row"><pre>        } else if (aData-&gt;distance &gt; bData-&gt;distance) {<span></span></pre></td></tr><tr><td scope="row"><pre>            return NSOrderedDescending;<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>            return NSOrderedSame;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }];<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    // Add subviews in descending Z-order so they overlap properly<span></span></pre></td></tr><tr><td scope="row"><pre>    for (NSData *d in [orderedDistances reverseObjectEnumerator]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        const DistanceAndIndex *distanceAndIndex = (const DistanceAndIndex *)d.bytes;<span></span></pre></td></tr><tr><td scope="row"><pre>        PlaceOfInterest *poi = (PlaceOfInterest *)[placesOfInterest objectAtIndex:distanceAndIndex-&gt;index];     <span></span></pre></td></tr><tr><td scope="row"><pre>        [self addSubview:poi.view];<span></span></pre></td></tr><tr><td scope="row"><pre>    }   <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)onDisplayLink:(id)sender<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CMDeviceMotion *d = motionManager.deviceMotion;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (d != nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        CMRotationMatrix r = d.attitude.rotationMatrix;<span></span></pre></td></tr><tr><td scope="row"><pre>        transformFromCMRotationMatrix(cameraTransform, &amp;r);<span></span></pre></td></tr><tr><td scope="row"><pre>        [self setNeedsDisplay];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)drawRect:(CGRect)rect<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (placesOfInterestCoordinates == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        return;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mat4f_t projectionCameraTransform;<span></span></pre></td></tr><tr><td scope="row"><pre>    multiplyMatrixAndMatrix(projectionCameraTransform, projectionTransform, cameraTransform);<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    int i = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    for (PlaceOfInterest *poi in [placesOfInterest objectEnumerator]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        vec4f_t v;<span></span></pre></td></tr><tr><td scope="row"><pre>        multiplyMatrixAndVector(v, projectionCameraTransform, placesOfInterestCoordinates[i]);<span></span></pre></td></tr><tr><td scope="row"><pre>        <span></span></pre></td></tr><tr><td scope="row"><pre>        float x = (v[0] / v[3] + 1.0f) * 0.5f;<span></span></pre></td></tr><tr><td scope="row"><pre>        float y = (v[1] / v[3] + 1.0f) * 0.5f;<span></span></pre></td></tr><tr><td scope="row"><pre>        if (v[2] &lt; 0.0f) {<span></span></pre></td></tr><tr><td scope="row"><pre>            poi.view.center = CGPointMake(x*self.bounds.size.width, self.bounds.size.height-y*self.bounds.size.height);<span></span></pre></td></tr><tr><td scope="row"><pre>            poi.view.hidden = NO;<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>            poi.view.hidden = YES;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        i++;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)locationManager:(CLLocationManager *)manager didUpdateToLocation:(CLLocation *)newLocation fromLocation:(CLLocation *)oldLocation<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [location release];<span></span></pre></td></tr><tr><td scope="row"><pre>    location = [newLocation retain];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (placesOfInterest != nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [self updatePlacesOfInterestCoordinates];<span></span></pre></td></tr><tr><td scope="row"><pre>    }   <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (id)initWithFrame:(CGRect)frame<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    self = [super initWithFrame:frame];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (self) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [self initialize];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return self;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (id)initWithCoder:(NSCoder *)aDecoder<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    self = [super initWithCoder:aDecoder];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (self) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [self initialize];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return self;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark Math utilities definition<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Creates a projection matrix using the given y-axis field-of-view, aspect ratio, and near and far clipping planes<span></span></pre></td></tr><tr><td scope="row"><pre>void createProjectionMatrix(mat4f_t mout, float fovy, float aspect, float zNear, float zFar)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    float f = 1.0f / tanf(fovy/2.0f);<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[0] = f / aspect;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[1] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[2] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[3] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[4] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[5] = f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[6] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[7] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[8] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[9] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[10] = (zFar+zNear) / (zNear-zFar);<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[11] = -1.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[12] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[13] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[14] = 2 * zFar * zNear /  (zNear-zFar);<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[15] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Matrix-vector and matrix-matricx multiplication routines<span></span></pre></td></tr><tr><td scope="row"><pre>void multiplyMatrixAndVector(vec4f_t vout, const mat4f_t m, const vec4f_t v)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    vout[0] = m[0]*v[0] + m[4]*v[1] + m[8]*v[2] + m[12]*v[3];<span></span></pre></td></tr><tr><td scope="row"><pre>    vout[1] = m[1]*v[0] + m[5]*v[1] + m[9]*v[2] + m[13]*v[3];<span></span></pre></td></tr><tr><td scope="row"><pre>    vout[2] = m[2]*v[0] + m[6]*v[1] + m[10]*v[2] + m[14]*v[3];<span></span></pre></td></tr><tr><td scope="row"><pre>    vout[3] = m[3]*v[0] + m[7]*v[1] + m[11]*v[2] + m[15]*v[3];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void multiplyMatrixAndMatrix(mat4f_t c, const mat4f_t a, const mat4f_t b)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    uint8_t col, row, i;<span></span></pre></td></tr><tr><td scope="row"><pre>    memset(c, 0, 16*sizeof(float));<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    for (col = 0; col &lt; 4; col++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        for (row = 0; row &lt; 4; row++) {<span></span></pre></td></tr><tr><td scope="row"><pre>            for (i = 0; i &lt; 4; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>                c[col*4+row] += a[i*4+row]*b[col*4+i];<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Initialize mout to be an affine transform corresponding to the same rotation specified by m<span></span></pre></td></tr><tr><td scope="row"><pre>void transformFromCMRotationMatrix(vec4f_t mout, const CMRotationMatrix *m)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[0] = (float)m-&gt;m11;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[1] = (float)m-&gt;m21;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[2] = (float)m-&gt;m31;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[3] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[4] = (float)m-&gt;m12;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[5] = (float)m-&gt;m22;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[6] = (float)m-&gt;m32;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[7] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[8] = (float)m-&gt;m13;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[9] = (float)m-&gt;m23;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[10] = (float)m-&gt;m33;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[11] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    mout[12] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[13] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[14] = 0.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>    mout[15] = 1.0f;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark -<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma mark Geodetic utilities definition<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// References to ECEF and ECEF to ENU conversion may be found on the web.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Converts latitude, longitude to ECEF coordinate system<span></span></pre></td></tr><tr><td scope="row"><pre>void latLonToEcef(double lat, double lon, double alt, double *x, double *y, double *z)<span></span></pre></td></tr><tr><td scope="row"><pre>{   <span></span></pre></td></tr><tr><td scope="row"><pre>    double clat = cos(lat * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double slat = sin(lat * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double clon = cos(lon * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double slon = sin(lon * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    double N = WGS84_A / sqrt(1.0 - WGS84_E * WGS84_E * slat * slat);<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    *x = (N + alt) * clat * clon;<span></span></pre></td></tr><tr><td scope="row"><pre>    *y = (N + alt) * clat * slon;<span></span></pre></td></tr><tr><td scope="row"><pre>    *z = (N * (1.0 - WGS84_E * WGS84_E) + alt) * slat;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Coverts ECEF to ENU coordinates centered at given lat, lon<span></span></pre></td></tr><tr><td scope="row"><pre>void ecefToEnu(double lat, double lon, double x, double y, double z, double xr, double yr, double zr, double *e, double *n, double *u)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    double clat = cos(lat * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double slat = sin(lat * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double clon = cos(lon * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double slon = sin(lon * DEGREES_TO_RADIANS);<span></span></pre></td></tr><tr><td scope="row"><pre>    double dx = x - xr;<span></span></pre></td></tr><tr><td scope="row"><pre>    double dy = y - yr;<span></span></pre></td></tr><tr><td scope="row"><pre>    double dz = z - zr;<span></span></pre></td></tr><tr><td scope="row"><pre>    <span></span></pre></td></tr><tr><td scope="row"><pre>    *e = -slon*dx  + clon*dy;<span></span></pre></td></tr><tr><td scope="row"><pre>    *n = -slat*clon*dx - slat*slon*dy + clat*dz;<span></span></pre></td></tr><tr><td scope="row"><pre>    *u = clat*clon*dx + clat*slon*dy + slat*dz;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>

        <div id="pageNavigationLinks_bottom" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='https://developer.apple.com/library/ios/samplecode/pARk/Listings/pARk_main_m.html'>Next</a><a class='previousLink' rel='prev' href='pARk_ARView_h.html'>Previous</a>
        </div><br/>
        <div class="copyright"><br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> Copyright &#x00a9; 2012 Apple Inc. All Rights Reserved. <a href="http://www.apple.com/legal/internet-services/terms/site.html" target="_blank">Terms of Use</a>   |  <a href="http://www.apple.com/privacy/" target="_blank">Privacy Policy</a>  |  Updated: 2012-06-26</p></div></div>

        <div id="pediaWindow">
            <div id="pediaHeader"></div>
            <div id="pediaBody"></div>
        </div>
    </article>

    <div id="blackout">
    <div id="preload"></div>
</div>
<div id="leave_feedback" class="button" role="button" tabindex="0">Feedback</div>
<div id="modal" aria-hidden="true">
    <div id="closebox" tabindex="0" aria-label="Close feedback form" role="button"></div>
    <div id="sending" class="hidden">
        <h2 tabindex="0">Sending feedback&hellip;</h2>
        <div id="sending_img"></div>
    </div>
    <div id="error" class="hidden">
        <h2 tabindex="0">We&rsquo;re sorry, an error has occurred.</h2>
        <p>Please try submitting your feedback later.</p>
        <div id="error_icon"></div>
    </div>
    <div id="success" class="hidden">
        <h2 tabindex="0">Thank you for providing feedback!</h2>
        <p>Your input helps improve our developer documentation.</p>
        <div id="thank_you_icon"></div>
    </div>
    
    <form id="feedback" action="#" method="post">
        <div class="left-leaf">
            <h2 id="helpful_title" data-asterisk="a1" tabindex="0">How helpful is this document?</h2>     
            <sup id="a1" class="asterisk" aria-hidden="true">*</sup>

            <div id="star_group" role="radiogroup" aria-required="true">
                <label> 
                    <input class="radio" type="radio" name="helped" value="1" /> 
                    Very helpful
                </label>
                <label> 
                    <input class="radio" type="radio" name="helped" value="2" /> 
                    Somewhat helpful
                </label>
                <label>
                    <input class="radio" type="radio" name="helped" value="3" /> 
                    Not helpful
                </label>
            </div>
        </div>
        <div class="right-leaf">
            <h2>How can we improve this document?</h2>
            <div id="improve" class="checkboxes">
                <label>
                    <input type="checkbox" name="typo" /> 
                    Fix typos or links
                </label>
                <label>
                    <input type="checkbox" name="infoIncorrect" /> 
                    Fix incorrect information
                </label>
                <label>
                    <input type="checkbox" name="needs_examples" /> 
                    Add or update code samples
                </label>
                <label>
                    <input type="checkbox" name="needs_art" /> 
                    Add or update illustrations
                </label>
                <label>
                    <input type="checkbox" name="missingInfo" /> 
                    Add information about...
                </label>
            </div>
        </div>

        <textarea id="comment" name="problem" cols="70" rows="8" placeholder="Please tell us more about your experience with this document" data-asterisk="a2" required></textarea>
        <sup id="a2" class="asterisk" aria-hidden="true">*</sup>

        <input id="email" type="email" name="email" placeholder="Email (optional)" size="48">

        <p class="fineprint">
            <em aria-hidden="true"><span>*</span> Required information</em>
        </p> 

        <input id="submit" type="button" value="Send" />

        <section id="legal">
            <p>
                To submit a product bug or enhancement request, please visit the 
                <a href="../../../../../bug-reporting/index.html" target="_blank">Bug Reporter</a> 
                page.
            </p>
            <p>
                Please read <a href="http://www.apple.com/legal/policies/ideas.html" target="_blank">Apple's Unsolicited Idea Submission Policy</a> 
                before you send us your feedback.
            </p> 
        </section>
    </form>
</div>

    
    <script charset="utf-8" src="../../../Resources/874/JavaScript/lib/prototype.js"></script>
    <script src="../../../Resources/874/JavaScript/library.js"></script>
    <script src="../../../Resources/874/JavaScript/feedback.js"></script>
</body>
<script type="text/javascript" src="../../../../webstats/pagetracker.js"></script>
<script type="text/javascript">
if(typeof PageTracker !== 'undefined') {
  if(window.addEventListener) {
    window.addEventListener("load", function(){PageTracker.logPageLoad()},false);
  } else if(window.attachEvent) {
    window.attachEvent("onload",function(){PageTracker.logPageLoad()});
  }
}
</script>
</html>
