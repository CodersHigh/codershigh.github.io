<!DOCTYPE html>
<html lang="en">
<head>
    <title>Technical Note TN2265: Troubleshooting Push Notifications</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta charset="utf-8">
    <meta id="book-resource-type" name="book-resource-type" content="Technical Note">
    <meta scheme="apple_ref" id="identifier" name="identifier" content="//apple_ref/doc/uid/DTS40010376">
	<meta id="document-version" name="document-version" content="5.0.0">
    <meta id="build" name="build" content="bcf073e0579478458b78c3b3068a2133">
    <meta id="chapterId" name="chapterId" content="DTS40010376-CH1">
    <meta id="date" name="date" content="2013-09-24">
    <meta id="description" name="description" content="TN2265: describes steps developers can take to troubleshoot sending and receiving of push notifications.">
    <meta id="book-title" name="book-title" content="Troubleshooting Push Notifications">
    <meta id="book-name" name="book-name" contents="DTS_TN2265_TroubleshootingP">
    <meta id="book-root" name="book-root" content="./">
    <meta id="book-json" name="book-json" content="book.json">
    <meta id="devcenter" name="devcenter" content="iOS Dev Center">
    <meta id="devcenter-url" name="devcenter-url" content="http://developer.apple.com/devcenter/ios">
    <meta id="reflib" name="reflib" content="iOS Developer Library">
    <meta id="book-assignments" name="book-assignments" content="{Type/Technical Note}, {Framework/Cocoa Touch Layer/UIKit}, {Topic/Networking & Internet}">
    
    
    <meta id="generator" name="generator" content="Gutenberg 003a3034">
    <meta name='numbat' content='aa879094b666337fdcde744b62fbff30'>
    <meta id="copyright" name="copyright" content="Copyright 2014 Apple Inc. All Rights Reserved.">
    <meta id="xcode-display" name="xcode-display" content="render">
    <meta id="IndexTitle" name="IndexTitle" content="Technical Note TN2265">
    <meta id="resources-uri" name="resources-uri" content="../../Resources/874">
    <link id="book-index-page" rel="Start" title="Troubleshooting Push Notifications" type="text/html" href="index.html">
    <link id="next-page" rel="Next" type="text/html" href="">
    <link id="previous-page" rel="Prev" type="text/html" href="">
    <link rel="stylesheet" type="text/css" href="../../Resources/874/CSS/screen.css">
    
    <link rel="stylesheet" type="text/css" href="../../Resources/874/CSS/feedback.css">
</head>    
<body><a name="//apple_ref/doc/uid/DTS40010376" title="Technical Note TN2265"></a>
    <div id="adcHeader" class="hideOnPrint hideInXcode">
        <div id='ssi_Header' class="hideInXcode phone">
            <a id="ssi_LibraryTitle" href='../../navigation/index.html'>iOS Developer Library</a>
            <a id="ssi_AppleDeveloperConnection" href='../../../../index.html'>Developer</a>
            <div id='ssi_SearchButton' role="button" title="Search">Search</div>
        </div>
        <form id='ssi_SearchMenu' method='get' action='../../search/' accept-charset='utf-8'>
            <label for='adcsearch'>Search iOS Developer Library</label>
            <input type='search' id='ssi_SearchField' name='q' accesskey='s' results='5' />
        </form>
    </div>

    <header id="header">
        <div id="title" role="banner">
            <h1>Troubleshooting Push Notifications</h1>
            <span id="file_links">
                <a id="PDF_link" role="button" tabindex='4' rel="alternate" title="Download PDF"><span id="pdf_icon"></span>PDF</a>
                <a id="Companion_link" role="button" tabindex='3' title="Download Companion File"><span id="companion_icon"></span>Companion File</a>
            </span>
        </div>
        <ul id="headerButtons" class="hideOnPrint" role="toolbar">
            <li id="toc_button" style="display:none">
                <button tabindex="5" id="table_of_contents" class="open" role="checkbox" aria-label="Show Table of Contents"><span class="disclosure"></span>Table of Contents</button>
            </li>
            <li id="jumpto_button" style="display:none" role="navigation"><select tabindex="6" id="jumpTo"><option value="top">Jump To&#133;</option></select></li>
            <li id="downloadSample_button" style="display:none">
                <a id="Sample_link"><button id="Sample_button">Download Sample Code</button></a>
            </li>
        </ul>
    </header>
    <nav id="tocContainer" tabindex="7">
        <ul id="toc" role="tree"></ul>
    </nav>

    <article id="contents" tabindex="0" role="main" class="dts_doc">
        <!-- CONTENTS -->
        <div id="pageNavigationLinks_top" class="pageNavigationLinks">
            
        </div>
        <a id="top" name="top"></a>
        <a id="INDEX" href="index.html" style="display:none;"></a>
        
        <a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_2" title="Technical Note TN2265"></a><div class="dtsDocNumber">Technical Note TN2265</div><h1 id="pageTitle">Troubleshooting Push Notifications</h1><p>Describes techniques you can use to resolve issues with sending and receiving push (remote) notifications in iOS and OS X.</p>

   
    <div class="outerMiniTOC">

        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG1">Introduction</a>
                
                
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG2">Issues with Receiving Push Notifications</a>
                
                
                
                    <div class="nestedMiniTOC">
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG21">Registering for Push Notifications</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG22">Registration Succeeded But No Notifications Received</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG23">Some Notifications Received, but Not All</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG24">Observing Push Status Messages</a>
                            
                        </div>
                        
                    
                    </div>
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG3">Issues with Sending Push Notifications</a>
                
                
                
                    <div class="nestedMiniTOC">
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG31">Problems Connecting to the Push Service</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG32">Handling Malformed Notifications</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG33">Using the Enhanced Notification Format</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG34">Issues with Using the Feedback Service</a>
                            
                        </div>
                        
                    
                    </div>
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG4">Other Tips and Tricks</a>
                
                
                
                    <div class="nestedMiniTOC">
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG44">Push Notification Throughput and Error Checking</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG41">IP Address Range Used by the Push Service</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG42">Resetting the Push Notifications Permissions Alert on iOS</a>
                            
                        </div>
                        
                    
                        
                        <div>
                            <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG43">Viewing a Certificate Signing Request (CSR)</a>
                            
                        </div>
                        
                    
                    </div>
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG5">References</a>
                
                
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG6">Downloadables</a>
                
                
                
            </div>
            
        
			
            <div>
                <a href="_index.html#/apple_ref/doc/uid/DTS40010376-RevisionHistory-DontLinkElementID_1">Document Revision History</a>
                
                
                
            </div>
            
        
    </div>

<section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG1" title="Introduction"></a><h2 class="jump">Introduction</h2><p>Many iOS and Mac applications present dynamic content delivered over the Internet. Push notifications (also known as remote notifications) are a way to let users know that new or updated content they're interested in is available.</p><p>This technote describes techniques you can use to resolve issues with sending and receiving push notifications.</p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_3" title="Note"></a><p><strong>Note:</strong>&nbsp;Push notifications became available on OS X starting with OS X Lion v10.7.</p><p></p></aside></div><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG2" title="Issues with Receiving Push Notifications"></a><h2 class="jump">Issues with Receiving Push Notifications</h2><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG21" title="Registering for Push Notifications"></a><h3 class="jump">Registering for Push Notifications</h3><p>In order to receive push notifications, an application must first register with the Apple Push Notification service (APNs or "push service"). Registration has three stages:</p><ol class="ol"><li class="li"><p>The application calls the <code>registerForRemoteNotificationTypes:</code> method of <code>UIApplication</code> (on iOS) or <code>NSApplication</code> (on OS X).</p></li><li class="li"><p>The application implements the <code>application:didRegisterForRemoteNotificationsWithDeviceToken:</code> method of <code>UIApplicationDelegate</code> (iOS) or <code>NSApplicationDelegate</code> (OS X) to receive the unique device token generated by the push service.</p></li><li class="li"><p>The application implements the <code>application:didFailToRegisterForRemoteNotificationsWithError:</code> method of <code>UIApplicationDelegate</code> (iOS) or <code>NSApplicationDelegate</code> (OS X) to receive an error if the registration failed.</p></li></ol><p>The application passes the device token to your provider as a non-object, binary value. The provider is your server that delivers dynamic content to your application.</p><p>Registering for push notifications is straightforward, but there are a few important details you need to be aware of.</p><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG211" title="No Delegate Callbacks"></a><h4 class="jump">No Delegate Callbacks</h4><p>When the first push-capable app is installed, iOS or OS X attempts to establish a persistent network connection to the push service that will be shared by all push-capable apps on the system. If neither delegate callback <code>application:didRegisterForRemoteNotificationsWithDeviceToken:</code> nor <code>application:didFailToRegisterForRemoteNotificationsWithError:</code> is called, that means that this connection has not yet been established.</p><p>This is not necessarily an error condition. The system may not have Internet connectivity at all because it is out of range of any cell towers or Wi-Fi access points, or it may be in airplane mode. Instead of treating this as an error, your app should continue normally, disabling only that functionality that relies on push notifications.</p><p>Keep in mind that network availability can change frequently. Once the persistent connection to the push service succeeds, one of the previously-mentioned application delegate methods will be called.</p><p>On iOS, push notifications use the cellular data network whenever possible, even if the device is currently using Wi-Fi for other network activity such as web browsing or email. However, the push service will fall back to Wi-Fi if cellular data service isn't available. </p><p>If your iOS device is capable of using the cellular data network, check that it has an active cellular data plan. Turn off Wi-Fi in Settings and see if you can still browse the web with Safari, for example. On the other hand, if the push service is using Wi-Fi, any firewalls between your device or computer and the Internet must allow TCP traffic to and from port 5223. </p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_4" title="Note"></a><p><strong>Note:</strong>&nbsp;There is a separate persistent connection to the push service for each environment. The operating system establishes a persistent connection to the sandbox environment for development builds; ad hoc and distribution builds connect to the production environment.</p><p></p></aside></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG212" title="Error Delegate Callback"></a><h4 class="jump">Error Delegate Callback</h4><p>The first time a push-capable iOS application is run, iOS asks the user if they want to receive push notifications for this app. If the app isn't even offering the option of receiving push notifications, the chances are that it is missing its <code>aps-environment</code> code signing entitlement. This entitlement is taken from the provisioning profile used when building the app, and it controls which push environment the app will connect to in order to receive remote notifications.</p><p>If an iOS app is running on a device, or if the app is a Mac app, the error method <code>application:didFailToRegisterForRemoteNotificationsWithError:</code> will be called if the code signing entitlements for accessing the push service are invalid. If you have not implemented this method in your application, you should do that as a way of checking that your <code>aps-environment</code> (iOS) or <code>com.apple.developer.aps-environment</code> (OS X) entitlement is present at runtime.</p><p>When using Xcode to submit an app, Xcode will re-sign it using the code signing identity and associated provisioning profile you select. So the signature of the submitted app and its contents might be different than what's in the Xcode archive.</p><p>Here's how to check the signature for an iOS app being submitted to the App Store:</p><ol class="ol"><li class="li"><p>In the Xcode Organizer, instead of Submit to the iOS App Store, do Save for Enterprise or Ad-Hoc Deployment. That will create a local copy of the .ipa file that would be submitted to the App Store.</p></li><li class="li"><p>When asked to choose an identity to sign with, select the same distribution identity you use when submitting to the App Store.</p></li><li class="li"><p>When asked to save the package, uncheck Save for Enterprise Distribution, then save the <code>.ipa</code> file.</p></li><li class="li"><p>Find the <code>.ipa</code> file and change its the extension to <code>.zip</code>.</p></li><li class="li"><p>Expand the <code>.zip</code> file. That will produce a <code>Payload</code> folder containing your app bundle.</p></li><li class="li"><p>Use the <code>codesign</code> <span class="content_text"><a href="x-man-page://1/codesign" class="urlLink" rel="external">tool</a></span> to check the entitlements on the app bundle like this:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE1"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ codesign -d --entitlements :- "Payload/YourApp.app"<span></span></pre></td></tr></table></div><p>where YourApp.app is the actual name of your app bundle.</p></li></ol><p>Here are the steps to do the same thing for a Mac app:</p><ol class="ol"><li class="li"><p>In the Xcode Organizer, instead of Submit to the Mac App Store, do Export as Mac Installer Package. That will create a local copy of the .pkg file that would be submitted to the Mac App Store.</p></li><li class="li"><p>When asked to choose an identity to sign with, select the same distribution identity you use when submitting to the Mac App Store.</p></li><li class="li"><p>Save the <code>.pkg</code> file when prompted.</p></li><li class="li"><p>Use the <code>pkgutil</code> <span class="content_text"><a href="x-man-page://1/pkgutil" class="urlLink" rel="external">tool</a></span> to expand the package into its components:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE2"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ pkgutil --expand "YourApp.pkg" Expanded_pkg<span></span></pre></td></tr></table></div><p>where YourApp.pkg is the actual name of the package you created in the previous step.</p></li><li class="li"><p>Expand the compressed payload inside the package using the <code>open</code> <span class="content_text"><a href="x-man-page://1/open" class="urlLink" rel="external">tool</a></span> or by double-clicking it: </p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE3"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ open Expanded_pkg/com.yourcompany.yourapp/Payload<span></span></pre></td></tr></table></div><p>where com.yourcompany.yourapp is the actual bundle ID of your app.</p></li><li class="li"><p>Use the <code>codesign</code> <span class="content_text"><a href="x-man-page://1/codesign" class="urlLink" rel="external">tool</a></span> to check the entitlements on the app bundle like this:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE4"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ codesign -d --entitlements - "Expanded_pkg/com.yourcompany.yourapp/YourApp.app"<span></span></pre></td></tr></table></div><p>where YourApp.app is the actual name of your app bundle.</p></li></ol><p>Check if there is an <code>aps-environment</code> or <code>com.apple.developer.aps-environment</code> code signing entitlement listed under <code>Internal requirements.</code> It would normally appear after the <code>application-identifier</code> (iOS) or <code>com.apple.application-identifier</code> (OS X) entitlement.</p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_5" title="Note"></a><p><strong>Note:</strong>&nbsp;This is a useful test to perform on your distribution builds before submitting them to the App Store.</p><p></p></aside></div><p>If the <code>aps-environment</code> or <code>com.apple.developer.aps-environment</code> entitlement is missing, check which item you selected on the "Choose an identity to sign with" sheet. The name of the provisioning profile is shown in gray above the name of the signing certificate. Then go to Devices &gt; Library &gt; Provisioning Profiles in the Organizer, control-click the provisioning profile, and select Reveal Profile in Finder.</p><p>Drag the profile to TextEdit so you can look at its contents, and search for Entitlements. If you don't see <code>aps-environment</code> or <code>com.apple.developer.aps-environment</code> in the entitlements, you've either not configured your app ID for production push notifications, or you haven't updated your distribution provisioning profile since configuring your app ID.</p><p>You probably created your distribution provisioning profile before you configured your App ID for push notifications in Member Center. Or. it might just be that the distribution provisioning profile installed on your build machine is older than the one in Member Center. In that case, delete the one on the build machine and click Refresh at the bottom right of the Organizer window.</p><p>Once you have a distribution provisioning profile installed on your build system with the correct push notifications entitlement, you will need to rebuild your app, and re-submit it to the store as an update. You may be able to request an expedited review using this <span class="content_text"><a href="https://developer.apple.com/appstore/contact/appreviewteam/index.html" class="urlLink" rel="external">form</a></span>.</p></section></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG22" title="Registration Succeeded But No Notifications Received"></a><h3 class="jump">Registration Succeeded But No Notifications Received</h3><p>If your app has registered with the push service but it is not receiving notifications, the problem can be either on the device/computer side or on the provider side. Here are a few things to check on the device/computer side.</p><p>The device or computer may have lost its persistent connection to the push service and can't reconnect. Try quitting the app and relaunching it to see if registration completes the next time. (On iOS 4 and later on devices that support multitasking, you will need to force quit the app from the recents list.) If the registration does not complete, iOS or OS X has been unable to re-establish the persistent connection. You can troubleshoot this as described in the previous two sections. </p><p>Your app may have sent an incorrect device token to your provider. Your app should always ask for the device token by registering with the push service each time it is launched. Don't store a device token from your app and try to reuse it, because the token can change. Your provider should then pass that same token on to the push service. </p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_6" title="Note"></a><p><strong>Note:</strong>&nbsp;The push service knows which app is supposed to receive a notification based on the User ID attribute in your TLS/SSL certificate. iOS or OS X will pass the notification to the app with the <code>CFBundleIdentifier</code> matching this attribute.</p><p></p></aside></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG23" title="Some Notifications Received, but Not All"></a><h3 class="jump">Some Notifications Received, but Not All</h3><p>If you are sending multiple notifications to the same device or computer within a short period of time, the push service will send only the last one.</p><p>Here's why. The device or computer acknowledges receipt of each notification. Until the push service receives that acknowledgment, it can only assume that the device or computer has gone off-line for some reason and stores the notification in the quality of service (QoS) queue for future redelivery. The round-trip network latency here is of course a major factor.</p><p>As described in the <span class="content_text"><a href="../../documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html#/apple_ref/doc/uid/TP40008194-CH100-SW4" class="browserLink" >Local and Push Notification Programming Guide</a></span>, the QoS queue holds a single notification per app per device or computer. If the service receives another notification before the one in the queue is sent, the new notification overwrites the previous one. </p><p>All of this points out that the intent is that a notification indicates to an app that something of interest has changed on the provider, and the app should check in with the provider to get the details. Notifications should not contain data which isn't also available elsewhere, and they should also not be stateful.</p><p>Any push notification that isn't delivered immediately was queued for future redelivery because your device was not connected to the service. "Immediately" of course needs to take latency for your connection into account. Outlying cases would be beyond 60 seconds as APNs will time out at that point.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG24" title="Observing Push Status Messages"></a><h3 class="jump">Observing Push Status Messages</h3><p>If these tips don't resolve the issue, you can enable additional messages from the APNs daemon on the device or computer.</p><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG241" title="Enabling Push Status Messages on iOS"></a><h4 class="jump">Enabling Push Status Messages on iOS</h4><p>To enable logging on iOS, install the configuration profile PersistentConnectionLogging.mobileconfig on your device by either putting the file on a web server and downloading it using Safari on your device, or by sending it as an email attachment and opening the attachment in Mail on your device. You'll be prompted to install "APS/PC Logging". Download the configuration profile by clicking Companion File at the upper right corner of this technote.</p><p>Once the configuration profile has been installed, turn the device off completely and then turn it back on. Then exercise your app again while watching the console using the Xcode Organizer. Or, sync your device with iTunes and the log will be saved in <code>~/Library/Logs/CrashReporter/MobileDevice/&lt;DEVICE_NAME&gt;/PersistentConnection/</code>.</p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_7" title="Note"></a><p><strong>Note:</strong>&nbsp;On iOS 6.x, push logs will not be written to the device console. They are only available by syncing the device with iTunes (r. 12575868).</p><p></p></aside></div><p>Look for messages from the <code>apsd</code> process. Ideally you'll see <code>Connected to courier x-courier.sandbox.push.apple.com</code> where <code>x</code> is a small integer. That indicates that the device has successfully established its persistent connection to the push service.</p><p>You might on the other hand see <code>Disconnecting in response to connection failure.</code> That means that the persistent connection failed. In that case, the goal is to figure out what's going on with your network that's causing the connection failure. Check that no firewalls are blocking TCP traffic on port 5223.</p><p>The message <code>connection set ignored topics</code> means that the user chose to turn off notifications for the apps listed in the message. That will be followed by <code>Sending filter message for enabled hashes</code> which is where iOS actually sends the enabled and ignored topics to APNs.</p><p>The message <code>Failed to parse JSON message payload</code> indicates that the JSON dictionary in the notification payload is not in valid JSON format.</p><p>The message <code>Received message for enabled topic &lt;your app's CFBundleIdentifier&gt;</code> means that the device received a notification from the push service.</p><p>On OS X, some log messages refer to the hash of your app's <code>CFBundleIdentifier</code>. Here's how to compute this SHA-1 hash:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE5"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ echo -n "&lt;your CFBundleIdentifier&gt;" | openssl dgst -sha1<span></span></pre></td></tr></table></div><p>If things appear to look normal in the log but you're still not receiving notifications, try turning off the Notifications switch in Settings, and then turn it back on. That will try to re-establish the device's persistent connection with APNs.</p><p>To remove the configuration profile, go to Settings &gt; General &gt; Profiles, tap "APS/PC Logging", then tap Remove. Turn the device off completely and turn it back on.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG242" title="Enabling Push Status Messages on OS X"></a><h4 class="jump">Enabling Push Status Messages on OS X</h4><p>To enable logging on OS X, use the following commands:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE6"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ sudo defaults write /Library/Preferences/com.apple.apsd APSWriteLogs -bool TRUE<span></span></pre></td></tr><tr><td scope="row"><pre>$ sudo defaults write /Library/Preferences/com.apple.apsd APSLogLevel -int 7<span></span></pre></td></tr><tr><td scope="row"><pre>$ sudo killall apsd<span></span></pre></td></tr></table></div><p>The logs are stored in <code>/Library/Logs/apsd.log</code>.</p></section></section><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG3" title="Issues with Sending Push Notifications"></a><h2 class="jump">Issues with Sending Push Notifications</h2><p>If your app is not receiving push notifications, and everything looks correct on the device or computer, here are some things to check on the server side.</p><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG31" title="Problems Connecting to the Push Service"></a><h3 class="jump">Problems Connecting to the Push Service</h3><p>One possibility is that your server is unable to connect to the push service. This can mean that you don't have the certificate chain needed for TLS/SSL to validate the connection to the service. In addition to the SSL identity (certificate and associated private key) created by Member Center, you should also install the Entrust CA (2048) root certificate on your provider. This allows TLS/SSL to verify the full APNs server cert chain. If you need to get this root certificate, you can download it from <span class="content_text"><a href="https://www.entrust.net/downloads/binary/entrust_2048_ca.cer" class="urlLink" rel="external">Entrust's site</a></span>. Also verify that these identities are installed in the correct location for your provider and that your provider has permission to read them. </p><p>You can test the TLS/SSL handshake using the OpenSSL <code>s_client</code> <span class="content_text"><a href="x-man-page://1/s_client" class="urlLink" rel="external">command</a></span>, like this:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE7"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ openssl s_client -connect gateway.sandbox.push.apple.com:2195 -cert YourSSLCertAndPrivateKey.pem -debug -showcerts -CAfile server-ca-cert.pem<span></span></pre></td></tr></table></div><p>where <code>server-ca-cert.pem</code> is the Entrust CA (2048) root certificate. </p><p>Be sure the SSL identity and the hostname are the correct ones for the push environment you're testing. You can configure your App ID in Member Center separately for the sandbox and production environment, and you will be issued a separate identity for each environment.</p><p>Using the sandbox SSL identity to try to connect to the production environment will return an error like this:</p><p><code>CRITICAL | 14:48:40.304061 | Exception creating ssl connection to Apple: [Errno 1] _ssl.c:480: error:14094414:SSL routines:SSL3_READ_BYTES:sslv3 alert certificate revoked</code></p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_8" title="Note"></a><p><strong>Note:</strong>&nbsp;The exact error will depend on your particular operating environment.</p><p></p></aside></div><p>One common OpenSSL error is <code>verify error:num=20:unable to get local issuer certificate</code>.</p><p>That message means that one or more of the certificates from the server could not be verified because the issuer (root or intermediate) certificates were not found.</p><p>The <code>CAfile</code> argument to <code>s_client</code> specifies the trusted root certificates to use to verify the server certificate. The trusted root certificate for the push servers is the Entrust CA (2048) root certificate mentioned previously.</p><p>If you can't even open a connection to APNs, perhaps your APNs TLS/SSL certificate has expired. These certificates are valid for one year but production APNs certificates can be renewed at any time.</p><p>Another possibility is that you've connected too many times to APNs and further connections have been temporarily blocked. As is documented in the <span class="content_text"><a href="http://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingWIthAPS/CommunicatingWIthAPS.html#/apple_ref/doc/uid/TP40008194-CH101-SW2" class="browserLink" >Local and Push Notification Programming Guide</a></span>, developers are expected to open a connection and leave it open. If a connection is opened and closed repeatedly, APNs will treat it as a denial of service attack and block connections for a period of time.</p><p>This temporary block will expire if no connection attempts are made for about one hour. </p><p>Yet another possibility is that there is a firewall blocking access to the ports used by APNs. Please see <span class="content_text"><a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG41">IP Address Range Used by the Push Service</a></span> for details. Try running a <code>telnet</code> command on your server to see if the server can reach APNs, like this:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE8"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ telnet 1-courier.push.apple.com 5223<span></span></pre></td></tr><tr><td scope="row"><pre>$ telnet gateway.sandbox.push.apple.com 2195<span></span></pre></td></tr><tr><td scope="row"><pre>$ telnet gateway.push.apple.com 2195<span></span></pre></td></tr></table></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG32" title="Handling Malformed Notifications"></a><h3 class="jump">Handling Malformed Notifications</h3><p>The simple notification format drops the connection if the push service receives a notification that is incorrect in some way. Your provider may see this as an <code>EPIPE</code> or broken pipe error in response to sending a notification. On the other hand, the enhanced notification format will send an error response with more detailed information about what was wrong with the notification before dropping the connection. Be sure your provider catches and handles these conditions properly. </p><p>Many push notification servers do not handle error responses or dropped connections robustly. An easy way to check this is to intentionally send a notification to a sandbox environment device token, assuming your server is communicating with the production push environment. Doing that should return an invalid token response and drop the connection. To learn more about checking error responses from the push service, please see <span class="content_text"><a href="_index.html#/apple_ref/doc/uid/DTS40010376-CH1-TNTAG44">Push Notification Throughput and Error Checking</a></span>.</p><p>The most common problem is an invalid device token. If the token came from the sandbox environment, such as when you are testing a development build in house, you can't send it to the production push service. Each push environment will issue a different token for the same device or computer. If you do send a device token to the wrong environment, the push service will see that as an invalid token and discard the notification.</p><div class="notebox"><aside><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_9" title="Note"></a><p><strong>Note:</strong>&nbsp;It is recommended that you run a separate instance of your provider for each push environment to avoid the problem of sending device tokens to the wrong environment.</p><p></p></aside></div><p>The user may have deleted your app from their device or computer. You should check the feedback service at least once a day for device tokens that are no longer active.</p><p>Other possible issues might be sending a payload longer than 256 bytes, your payload might not be formatted correctly, or perhaps your JSON dictionary has incorrect syntax.</p><p>An occasional disconnect while your provider is idle is nothing to be concerned about; just re-establish the connection and carry on. If one of the push servers is down, the load balancing mechanism will transparently direct your new connection to another server assuming you connect by hostname and not by static IP address.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG33" title="Using the Enhanced Notification Format"></a><h3 class="jump">Using the Enhanced Notification Format</h3><p>If your provider is using the original simple notification, consider migrating to the enhanced notification format. That interface provides more control over the expiration of notifications and also returns more detailed error responses if a problem occurs with a particular notification.</p><p>You can read more about the enhanced notification format in the <span class="content_text"><a href="http://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CommunicatingWIthAPS/CommunicatingWIthAPS.html#/apple_ref/doc/uid/TP40008194-CH101-SW4" class="browserLink" >Local and Push Notification Programming Guide</a></span>.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG34" title="Issues with Using the Feedback Service"></a><h3 class="jump">Issues with Using the Feedback Service</h3><p>If you remove your app from your device or computer and then send a push notification to it, you would expect to have the device token rejected, and the invalidated device token should appear on the feedback service. However, if this was the last push-enabled app on the device or computer, it will not show up in the feedback service. This is because deleting the last app tears down the persistent connection to the push service before the notice of the deletion can be sent.</p><p>You can work around this by leaving at least one push-enabled app on the device or computer in order to keep the persistent connection up. To keep the persistent connection to the production environment up, just install any free push-enabled app from the App Store and you should then be able to delete your app and see it appear in the feedback service.</p><p>Recall that each push environment has its own persistent connection. So to keep the persistent connection to the sandbox environment up, install another development push-enabled app.</p></section><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG4" title="Other Tips and Tricks"></a><h2 class="jump">Other Tips and Tricks</h2><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG44" title="Push Notification Throughput and Error Checking"></a><h3 class="jump">Push Notification Throughput and Error Checking</h3><p>There are no caps or batch size limits for using APNs. The iOS 6.1 press release stated that APNs has sent over 4 trillion push notifications since it was established. It was announced at WWDC 2012 that APNs is sending 7 billion notifications daily.</p><p>If you're seeing throughput lower than 9,000 notifications per second, your server might benefit from improved error handling logic.</p><p>Here's how to check for errors when using the enhanced notification format. Keep writing until a write fails. If the stream is ready for writing again, resend the notification and keep going. If the stream isn't ready for writing, see if the stream is available for reading.</p><p>If it is, read everything available from the stream. If you get zero bytes back, the connection was closed because of an error such as an invalid command byte or other parsing error. If you get six bytes back, that's an error response that you can check for the response code and the ID of the notification that caused the error. You'll need to send every notification following that one again.</p><p>Once everything has been sent, do one last check for an error response.</p><p>It can take a while for the dropped connection to make its way from APNs back to your server just because of normal latency. It's possible to send over 500 notifications before a write fails because of the connection being dropped. Around 1,700 notifications writes can fail just because the pipe is full, so just retry in that case once the stream is ready for writing again. </p><p>Now, here's where the tradeoffs get interesting. You can check for an error response after every write, and you'll catch the error right away. But this causes a huge increase in the time it takes to send a batch of notifications.</p><p>Device tokens should almost all be valid if you've captured them correctly and you're sending them to the correct environment. So it makes sense to optimize assuming failures will be rare. You'll get way better performance if you wait for write to fail or the batch to complete before checking for an error response, even counting the time to send the dropped notifications again. </p><p>None of this is really specific to APNs, it applies to most socket-level programming.</p><p>If your development tool of choice supports multiple threads or interprocess communication, you could have a thread or process waiting for an error response all the time and let the main sending thread or process know when it should give up and retry.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG41" title="IP Address Range Used by the Push Service"></a><h3 class="jump">IP Address Range Used by the Push Service</h3><p>Push providers, iOS devices, and Mac computers are often behind firewalls. To send notifications, you will need to allow inbound and outbound TCP packets over port 2195. To reach the feedback service, you will need to allow inbound and outbound TCP packets over port 2196. Devices and computers connecting to the push service over Wi-Fi will need to allow inbound and outbound TCP packets over port 5223.</p><p>The IP address range for the push service is subject to change; the expectation is that providers will connect by hostname rather than IP address. The push service uses a load balancing scheme that yields a different IP address for the same hostname. However, the entire 17.0.0.0/8 address block is assigned to Apple, so you can specify that range in your firewall rules.</p></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG42" title="Resetting the Push Notifications Permissions Alert on iOS"></a><h3 class="jump">Resetting the Push Notifications Permissions Alert on iOS</h3><p>The first time a push-enabled app registers for push notifications, iOS asks the user if they wish to receive notifications for that app. Once the user has responded to this alert it is not presented again unless the device is restored or the app has been uninstalled for at least a day.</p><p>If you want to simulate a first-time run of your app, you can leave the app uninstalled for a day. You can achieve the latter without actually waiting a day by following these steps: </p><ol class="ol"><li class="li"><p>Delete your app from the device.</p></li><li class="li"><p>Turn the device off completely and turn it back on.</p></li><li class="li"><p>Go to Settings &gt; General &gt; Date &amp; Time and set the date ahead a day or more.</p></li><li class="li"><p>Turn the device off completely again and turn it back on.</p></li></ol></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG43" title="Viewing a Certificate Signing Request (CSR)"></a><h3 class="jump">Viewing a Certificate Signing Request (CSR)</h3><p>Part of configuring your App ID for push notifications is creating a certificate signing request, or CSR. Occasionally it's useful to look at the contents of a CSR, which you can do with the OpenSSL <code>req</code> <span class="content_text"><a href="x-man-page://1/req" class="urlLink" rel="external">command</a></span>:</p><a name="//apple_ref/doc/uid/DTS40010376-CH1-SOURCECODE9"></a><div class="codesample clear"><table><tr><td scope="row"><pre>$ openssl req -noout -text -in server.csr<span></span></pre></td></tr></table></div></section><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG5" title="References"></a><h2 class="jump">References</h2><p><span class="content_text"><a href="../../documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Introduction.html#/apple_ref/doc/uid/TP40008194" class="urlLink" rel="external">Local and Push Notification Programming Guide</a></span></p><p><span class="content_text"><a href="../../documentation/IDEs/Conceptual/AppDistributionGuide/Introduction/Introduction.html#/apple_ref/doc/uid/TP40012582" class="browserLink" >App Distribution Guide</a></span></p><p><span class="content_text"><a href="http://support.apple.com/kb/HT3576" class="urlLink" rel="external">Understanding Notifications</a></span></p><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><section><a name="//apple_ref/doc/uid/DTS40010376-CH1-TNTAG6" title="Downloadables"></a><h2 class="jump">Downloadables</h2><ul class="ul"><li class="li"><p>PersistentConnectionLogging.zip ("tn2265_PersistentConnectionLogging.zip", 3.2K)

</p></li></ul><div class="back_to_top"><a href="_index.html#top">Back to Top</a></div></section><br/><hr/><a name="//apple_ref/doc/uid/DTS40010376-CH1-DontLinkElementID_1" title="Document Revision History"></a><a name="//apple_ref/doc/uid/DTS40010376-RevisionHistory-DontLinkElementID_1" title="Document Revision History"></a><h4>Document Revision History</h4><br/><table class="graybox revision-history" border="0" cellspacing="0" cellpadding="5"><colgroup span="1"><col width="145" /></colgroup><tr><th scope="col" align="left"><strong>Date</strong></th><th scope="col" align="left"><strong>Notes</strong></th></tr><tr><td scope="row">2013-09-24</td><td><p>Minor editorial changes.</p></td></tr><tr><td scope="row">2013-09-17</td><td><p>Updated the PersistentConnectionLogging configuration profile and instructions for resetting the push permissions alert. Other minor changes.</p></td></tr><tr><td scope="row">2013-03-29</td><td><p>Fixed link to PersistentConnectionLogging configuration profile.</p></td></tr><tr><td scope="row">2013-03-27</td><td><p>Expanded coverage of checking code signing entitlements and error responses. </p></td></tr><tr><td scope="row">2011-09-26</td><td><p>Update link to Entrust root certificate. Replace apsd logging configuration profile with a signed version.</p></td></tr><tr><td scope="row">2011-06-08</td><td><p>Added information about push notifications in Mac OS X Lion.</p></td></tr><tr><td scope="row">2010-09-29</td><td><p>New document that 
					describes steps developers can take to troubleshoot sending and receiving of push notifications.</p></td></tr></table><br/>
        <div id="pageNavigationLinks_bottom" class="pageNavigationLinks">
            
        </div><br/>
        <div class="copyright"><br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> Copyright &#x00a9; 2013 Apple Inc. All Rights Reserved. <a href="http://www.apple.com/legal/internet-services/terms/site.html" target="_blank">Terms of Use</a>   |  <a href="http://www.apple.com/privacy/" target="_blank">Privacy Policy</a>  |  Updated: 2013-09-24</p></div></div>

        <!-- /CONTENTS -->
        <div id="pediaWindow">
            <div id="pediaHeader"></div>
            <div id="pediaBody"></div>
        </div>
    </article>

    <div id="blackout">
    <div id="preload"></div>
</div>
<div id="leave_feedback" class="button" role="button" tabindex="0">Feedback</div>
<div id="modal" aria-hidden="true">
    <div id="closebox" tabindex="0" aria-label="Close feedback form" role="button"></div>
    <div id="sending" class="hidden">
        <h2 tabindex="0">Sending feedback&hellip;</h2>
        <div id="sending_img"></div>
    </div>
    <div id="error" class="hidden">
        <h2 tabindex="0">We&rsquo;re sorry, an error has occurred.</h2>
        <p>Please try submitting your feedback later.</p>
        <div id="error_icon"></div>
    </div>
    <div id="success" class="hidden">
        <h2 tabindex="0">Thank you for providing feedback!</h2>
        <p>Your input helps improve our developer documentation.</p>
        <div id="thank_you_icon"></div>
    </div>
    
    <form id="feedback" action="#" method="post">
        <div class="left-leaf">
            <h2 id="helpful_title" data-asterisk="a1" tabindex="0">How helpful is this document?</h2>     
            <sup id="a1" class="asterisk" aria-hidden="true">*</sup>

            <div id="star_group" role="radiogroup" aria-required="true">
                <label> 
                    <input class="radio" type="radio" name="helped" value="1" /> 
                    Very helpful
                </label>
                <label> 
                    <input class="radio" type="radio" name="helped" value="2" /> 
                    Somewhat helpful
                </label>
                <label>
                    <input class="radio" type="radio" name="helped" value="3" /> 
                    Not helpful
                </label>
            </div>
        </div>
        <div class="right-leaf">
            <h2>How can we improve this document?</h2>
            <div id="improve" class="checkboxes">
                <label>
                    <input type="checkbox" name="typo" /> 
                    Fix typos or links
                </label>
                <label>
                    <input type="checkbox" name="infoIncorrect" /> 
                    Fix incorrect information
                </label>
                <label>
                    <input type="checkbox" name="needs_examples" /> 
                    Add or update code samples
                </label>
                <label>
                    <input type="checkbox" name="needs_art" /> 
                    Add or update illustrations
                </label>
                <label>
                    <input type="checkbox" name="missingInfo" /> 
                    Add information about...
                </label>
            </div>
        </div>

        <textarea id="comment" name="problem" cols="70" rows="8" placeholder="Please tell us more about your experience with this document" data-asterisk="a2" required></textarea>
        <sup id="a2" class="asterisk" aria-hidden="true">*</sup>

        <input id="email" type="email" name="email" placeholder="Email (optional)" size="48">

        <p class="fineprint">
            <em aria-hidden="true"><span>*</span> Required information</em>
        </p> 

        <input id="submit" type="button" value="Send" />

        <section id="legal">
            <p>
                To submit a product bug or enhancement request, please visit the 
                <a href="../../../../bug-reporting/index.html" target="_blank">Bug Reporter</a> 
                page.
            </p>
            <p>
                Please read <a href="http://www.apple.com/legal/policies/ideas.html" target="_blank">Apple's Unsolicited Idea Submission Policy</a> 
                before you send us your feedback.
            </p> 
        </section>
    </form>
</div>

    
    <script charset="utf-8" src="../../Resources/874/JavaScript/lib/prototype.js"></script>
    <script src="../../Resources/874/JavaScript/library.js"></script>
    <script src="../../Resources/874/JavaScript/feedback.js"></script>
</body>
<script type="text/javascript" src="../../../webstats/pagetracker.js"></script>
<script type="text/javascript">
if(typeof PageTracker !== 'undefined') {
  if(window.addEventListener) {
    window.addEventListener("load", function(){PageTracker.logPageLoad()},false);
  } else if(window.attachEvent) {
    window.attachEvent("onload",function(){PageTracker.logPageLoad()});
  }
}
</script>
</html>
